# Telegram群组/频道采集系统 - 共识文档

## 1. 项目概述

### 1.1 项目名称
Telegram群组/频道采集系统 (Telegram Collector)

### 1.2 项目目标
开发一个基于Flask的Web可视化系统，通过Telegram Client API自动化采集群组、频道及其聊天内容，支持任务化管理、数据过滤、实时监听和API推送。

### 1.3 技术栈
- **后端框架**: Flask 3.x
- **Python版本**: 3.12
- **数据库**: SQLite3
- **Telegram客户端**: Telethon
- **前端**: Bootstrap 5 + jQuery (CDN集成)
- **异步处理**: threading + asyncio
- **UI风格**: 现代化、美观的响应式界面

---

## 2. 核心功能需求

### 2.1 Telegram账号管理
- **配置管理**
  - 配置 `api_id` 和 `api_hash`
  - 手机号登录流程（验证码输入）
  - 会话持久化（避免重复登录）
  - 登录状态显示

### 2.2 采集任务管理
- **任务创建**
  - 任务名称
  - 目标机器人用户名（用于搜索群组/频道链接）
  - 群组/频道名称正则过滤
  - 消息内容正则过滤
  - 搜索翻页配置（下一页按钮文字、选择器等）
  - API推送配置（URL、方法、参数映射）
  
- **任务执行**
  - 一次性采集历史消息（全部）
  - 实时监听新消息
  - 后台异步执行
  - 任务状态管理（待执行、运行中、已停止、已完成、失败）

- **任务操作**
  - 启动任务
  - 停止任务
  - 删除任务
  - 查看任务详情
  - 编辑任务配置

### 2.3 数据采集功能
- **采集流程**
  1. 与目标机器人对话
  2. 搜索并提取群组/频道链接
  3. 使用翻页配置获取更多结果
  4. 根据正则过滤群组/频道
  5. 加入并采集消息内容
  6. 根据正则过滤消息
  7. 推送到API服务器

- **采集内容**
  - 群组/频道基本信息（ID、名称、描述、成员数）
  - 消息内容（文本、发送者、时间戳、消息ID）
  - 媒体信息（类型、文件名，不下载文件）

### 2.4 数据管理
- **数据展示**
  - 采集到的群组/频道列表
  - 消息列表（分页显示）
  - 数据统计（总数、今日新增等）

- **数据操作**
  - 搜索/过滤（按关键词、时间范围、来源）
  - 数据导出（CSV、JSON格式）
  - 数据删除

- **统计图表**
  - 采集数量趋势图
  - 群组/频道分布
  - 消息类型统计

### 2.5 API推送配置
- **推送设置**
  - API地址（URL）
  - 请求方法（GET/POST）
  - 自定义参数映射
    - 消息内容 → 参数名
    - 发送者 → 参数名
    - 时间戳 → 参数名
    - 群组名称 → 参数名
    - 自定义字段
  - 推送失败重试机制

---

## 3. 技术实现方案

### 3.1 系统架构
```
┌─────────────────────────────────────────┐
│         Web前端 (Bootstrap + jQuery)      │
│  - 任务管理界面                           │
│  - 数据展示界面                           │
│  - 配置管理界面                           │
└──────────────┬──────────────────────────┘
               │ HTTP/AJAX
┌──────────────▼──────────────────────────┐
│         Flask后端 (Python 3.12)          │
│  - RESTful API                           │
│  - 任务调度器                             │
│  - 数据处理逻辑                           │
└──────────────┬──────────────────────────┘
               │
    ┌──────────┼──────────┐
    │          │          │
┌───▼───┐  ┌──▼───┐  ┌──▼────────┐
│SQLite3│  │Telethon│ │外部API服务│
│数据库  │  │Client  │ │(数据推送) │
└───────┘  └────────┘ └───────────┘
```

### 3.2 数据库设计
- **accounts表**: Telegram账号配置
- **tasks表**: 采集任务配置
- **groups表**: 采集到的群组/频道
- **messages表**: 采集到的消息
- **api_logs表**: API推送日志

### 3.3 异步任务处理
- 使用 `threading.Thread` 运行后台任务
- 使用 `asyncio` 处理Telethon异步操作
- 任务状态通过数据库同步

### 3.4 翻页搜索机制
- 配置下一页按钮的识别规则（文字、CSS选择器）
- 自动点击翻页并提取链接
- 支持最大翻页次数限制

---

## 4. 任务边界与约束

### 4.1 功能边界
**包含：**
- ✅ Web可视化管理界面
- ✅ Telegram账号登录和管理
- ✅ 任务化采集管理
- ✅ 正则表达式过滤
- ✅ 实时监听新消息
- ✅ API数据推送
- ✅ 数据导出和统计

**不包含：**
- ❌ 媒体文件下载
- ❌ 多账号并发采集
- ❌ 分布式部署
- ❌ 用户权限管理
- ❌ API推送认证

### 4.2 技术约束
- Python 3.12 兼容性
- Flask 3.x 特性
- SQLite3 单文件数据库
- 单机部署
- 无需外部消息队列（Redis/RabbitMQ）

### 4.3 性能约束
- 单任务顺序执行
- 数据库查询分页（每页50条）
- API推送超时时间（30秒）
- 最大翻页次数（可配置，默认10页）

---

## 5. 验收标准

### 5.1 功能验收
- [ ] 成功配置Telegram账号并登录
- [ ] 创建采集任务并配置所有参数
- [ ] 任务能够搜索机器人对话中的群组/频道链接
- [ ] 正则过滤正常工作（群组名称和消息内容）
- [ ] 翻页功能正常获取更多结果
- [ ] 历史消息全部采集完成
- [ ] 实时监听新消息并采集
- [ ] 数据成功推送到API服务器
- [ ] 数据导出功能正常（CSV/JSON）
- [ ] 搜索和过滤功能正常
- [ ] 统计图表正确显示

### 5.2 界面验收
- [ ] 界面美观、现代化
- [ ] 响应式设计（支持移动端）
- [ ] 操作流畅无卡顿
- [ ] 错误提示友好清晰

### 5.3 稳定性验收
- [ ] 任务异常不影响系统运行
- [ ] API推送失败有重试机制
- [ ] 数据库操作有异常处理
- [ ] 长时间运行无内存泄漏

---

## 6. 项目结构

```
telegram-collector/
├── app.py                 # Flask应用入口
├── config.py              # 配置文件
├── requirements.txt       # 依赖包
├── .env                   # 环境变量（API密钥）
├── .gitignore            # Git忽略文件
├── database/
│   ├── __init__.py
│   ├── models.py         # 数据模型
│   └── db.py             # 数据库操作
├── services/
│   ├── __init__.py
│   ├── telegram_service.py   # Telegram客户端服务
│   ├── task_service.py       # 任务管理服务
│   └── api_service.py        # API推送服务
├── routes/
│   ├── __init__.py
│   ├── auth.py           # 账号管理路由
│   ├── tasks.py          # 任务管理路由
│   └── data.py           # 数据管理路由
├── static/
│   ├── css/
│   │   └── custom.css    # 自定义样式
│   └── js/
│       └── main.js       # 前端逻辑
└── templates/
    ├── base.html         # 基础模板
    ├── index.html        # 首页
    ├── auth.html         # 账号配置
    ├── tasks.html        # 任务管理
    └── data.html         # 数据展示
```

---

## 7. 开发优先级

### Phase 1: 基础框架（核心）
1. 项目结构搭建
2. 数据库模型设计
3. Flask基础路由
4. 前端基础模板

### Phase 2: Telegram集成（核心）
1. Telethon客户端封装
2. 账号登录流程
3. 会话管理

### Phase 3: 采集功能（核心）
1. 机器人对话搜索
2. 群组/频道链接提取
3. 翻页功能实现
4. 消息采集逻辑
5. 正则过滤实现

### Phase 4: 任务管理（核心）
1. 任务CRUD操作
2. 后台任务执行
3. 实时监听实现
4. 任务状态管理

### Phase 5: 数据管理（重要）
1. 数据展示界面
2. 搜索和过滤
3. 数据导出
4. API推送功能

### Phase 6: 优化完善（次要）
1. 统计图表
2. 界面美化
3. 错误处理优化
4. 性能优化

---

## 8. 风险与应对

### 8.1 技术风险
- **风险**: Telegram API限制（频率限制、封号）
  - **应对**: 添加请求间隔、错误重试、会话保持

- **风险**: 异步任务管理复杂
  - **应对**: 使用简单的线程模型，状态通过数据库同步

- **风险**: 翻页逻辑不稳定
  - **应对**: 提供灵活的配置选项，支持多种识别方式

### 8.2 业务风险
- **风险**: 目标机器人对话格式变化
  - **应对**: 提供灵活的正则配置和手动调整选项

---

## 9. 确认清单

- [x] 需求边界清晰无歧义
- [x] 技术方案可行
- [x] 验收标准明确
- [x] 项目结构合理
- [x] 开发优先级明确
- [x] 风险识别完整

---

**文档版本**: v1.0  
**创建时间**: 2025-12-03  
**状态**: ✅ 已确认
